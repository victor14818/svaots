<html>
    <head>
	<title>Buscar OT</title>      
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	{{ Html::style('css/bootstrap.min.css') }}
	{{ Html::script('js/jquery.min.js') }}
	{{ Html::script('js/bootstrap.min.js') }}
	<script>
	    function getIssue(id){
			$("#id_adjuntos").html(''); 
			if(id > 0)
			{
				var tr_id = id;
				//alert(tr_id);
					$.ajax({
						type:'POST',
						url:'{{ url('/') }}/buscar_tarea',
						data: {_token:"<?php echo csrf_token() ?>", tarea_id: tr_id},
						success:function(data){
							$("#id_subject").html(data.issue_subject);
							$("#id_description").html(data.issue_description);
							$("#id_status").html(data.issue_status);
							$("#id_done_ratio").html('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="'+data.issue_done_ratio+'" aria-valuemin="0" aria-valuemax="100" style="width:'+data.issue_done_ratio+'%">'+data.issue_done_ratio+'%</div></div>');
							$("#id_start_date").html(data.issue_start_date);
							$("#id_due_date").html(data.issue_due_date);
							$("#id_fin_date").html(data.fecha_finalizacion);
							$("#issue_assigned").html(data.issue_assigned);
							$("#id_journals").html(data.journals);
							$("#id_no").html(id);
							document.getElementById("id_no").value = id;
							$("#id_project").html(data.issue_project_name);
							document.getElementById("id_project").value = data.issue_project_name;
							$("#id_dias").html(data.tiempo_activo);
							
							if(data.flag != "0"){
								if(data.estado == 1 && data.issue_status == "Closed"){ 
									document.getElementById("btn_enc").style.display = "block"; 
								}	
								document.getElementById("div_alert_error").style.display = "none"; 
							}else{ document.getElementById("div_alert_error").style.display = "block"; }
								
							},
						error:function(request, status, error){
							alert("Tarea no encontrada comunicarse con Ingeniería SVA(ingenieriasva@claro.com.gt) ");
							document.getElementById("div_alert_error").style.display = "block";
					}
				});
			}
	    }
	    function searchIssue(event){
			getIssue(document.getElementById("id_search").value);
	    }
	    function ingresar_encuesta(){
			var enc_rst_req = $("input[type='radio'][name='rst_req']:checked").val();
			var enc_rst_req_time = $("input[type='radio'][name='rst_time_req']:checked").val();
			var enc_rst_obs = document.getElementById("enc_obs").value;
			var enc_id = document.getElementById("id_no").value;
			var enc_id_proyecto = document.getElementById("id_project").value;
			if(typeof(enc_rst_req) != "undefined" && typeof(enc_rst_req_time) != "undefined" && typeof(enc_id) != "undefined" && typeof(enc_id_proyecto) != "undefined")
			{
				$.ajax({
					type:'POST',
					url:'{{ url('/') }}/ingresar_encuesta',
					data: {_token:"<?php echo csrf_token() ?>", resultado: enc_rst_req, tiempo: enc_rst_req_time, observaciones: enc_rst_obs, tarea: enc_id, proyecto: enc_id_proyecto},

					success:function(data){
						alert("Encuesta correctamente ingresada");
						document.getElementById("btn_enc").style.display = "none"; 		
					},
					error:function(request, status, error){
							alert("Ha ocurrido un error comunicarse con Ingeniería SVA(ingenieriasva@claro.com.gt)");
					}
				});
			} else { alert("Ha ocurrido un error comunicarse con Ingeniería SVA(ingenieriasva@claro.com.gt)"); }
	    }
		
		function sendCode(event){
			var tr_id = document.getElementById("id_no").value;
			var tr_cd = document.getElementById("id_search_code").value;
			$.ajax({
				type:'POST',
				url:'{{ url('/') }}/buscar_code',
				data: {_token:"<?php echo csrf_token() ?>", tarea_id: tr_id, tarea_cd: tr_cd},
				success:function(data){
					$("#id_adjuntos").html(data.down_links); 
				},
				error:function(request, status, error){
					alert("Código incorrecto comunicarse con Ingeniería SVA(ingenieriasva@claro.com.gt) para más información ");
				}
			});
		}
	    
	</script>
    </head>
    <body>
	<div class="container">
	    <center><h1>Buscar OT</h1><hr></center>
	    <a href="/" class="btn btn-warning">Inicio</a><hr>
	    <div class="panel panel-danger">
	        <div class="panel-heading">Datos de la tarea</div>
	        <div class="panel-body">
		    <div class="row">
	    		<div class="col-md-2">
	  		    {{ Form::label('Número de Tarea') }}
			</div>
	    		<div class="col-md-4">
	  		    {{ Form::text('tarea_id', '', array('class' => 'form-control', 'required', 'id' => 'id_search')) }}
			</div>
	    		<div class="col-md-2">
	  		    {{ Form::button('Buscar',['onClick'=>'searchIssue(event)', 'class' => 'btn btn-danger form-control']) }}
			</div>
		    </div>
		</div>
	    </div>

	    <!-- Detalle -->
	    <div class="panel panel-danger">
	        <div class="panel-heading">Detalle de la tarea</div>
	        <div class="panel-body">
		    <div id="div_alert_error" class="alert alert-warning alert-dismissable" style="display:none">
			<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
			Tarea no encontrada, por favor comuniquese con el personal de Ingeniería SVA (ingenieriasva@claro.com.gt)
		    </div>
		    <button id="btn_enc" class="btn btn-danger form-control" data-toggle="modal" data-target="#myModal" style="display:none">Llenar encuesta de finalización</button>
		    <table class="table">
		    <tr><td><strong>Número de OT:</strong></td><td><label id="id_no" value=""></label><td></tr>
		    <tr><td><strong>Proyecto:</strong></td><td><label id="id_project" value=""></label></td></tr>
		    <tr><td><strong>Asunto:</strong></td><td><label id="id_subject"></label></td></tr>
		    <tr><td><strong>Descripción:</strong></td><td><label id="id_description"></label></td></tr>
		    <tr><td><strong>Estado:</strong></td><td><label id="id_status"></label></td></tr>
		    <tr><td><strong>Progreso</strong></td><td><div id="id_done_ratio"></div></td></tr>
		    <tr><td><strong>Fecha de inicio:</strong></td><td><label id="id_start_date"></label></td></tr>
		    <tr><td><strong>Fecha de finalización estimada:</strong></td><td><label id="id_due_date"></label></td></tr>
		    <tr><td><strong>Fecha de finalización:</strong></td><td><label id="id_fin_date"></label></td></tr>
		    <tr><td><strong>Responsable</strong></td><td><label id="issue_assigned"></label></td></tr>
		    <tr><td><strong>Días activo:</strong></td><td><label id="id_dias"></label></td></tr>
		    <tr><td><strong>Código</strong></td>
				<td>
				<div class="row">
					<div class="col-md-4">
						{{ Form::text('id_code', '', array('class' => 'form-control', 'id' => 'id_search_code')) }}
					</div>
					<div class="col-md-4">
						{{ Form::button('Ingresar Código',['onClick'=>'sendCode(event)', 'class' => 'btn btn-danger form-control']) }}
					</div>
				</div>
				</td>
			</tr>
		    <tr><td colspan="2"><div id="id_adjuntos"></div></td></tr>
			</table>
		    <h3>Notas</h3>
		    <div id="id_journals"></div>
		</div>
	    </div>
	</div>

	<div class="container">
	    <h2>Listado de Tareas</h2>
	    <table id="tabla_tareas" class="table table-striped table-bordered">
		<thead>
		    <tr>
		        <th>No. Tarea</th>
		        <th>Autor</th>
		        <th>Asunto</th>
		        <th>Fecha de Creación</th>
		        <th>Días en proceso</th>
		        <th>Estado</th>
		        <th>Progreso</th>
		    </tr>
		</thead>
		<tbody>
		    @foreach ($tareas as $tarea)
			<tr>
			    <td>{{ $tarea->tarea }}</td>
			    <td>{{ $tarea->nombre_cntct }}</td>
			    <td>{{ $tarea->asunto }}</td>
			    <td>{{ $tarea->created_at }}</td>
				<td>
					@if($tarea->estado == 0)
						<div id="div_alert_error" class="alert alert-info">{{ ceil((strtotime($tarea->fecha_finalizacion) - strtotime($tarea->created_at))/86400)}}</div>
					@else
						@php $days = ceil((time() - strtotime($tarea->created_at))/86400) @endphp
						@if($days == 1)
							<div id="div_alert_error" class="alert alert-success"> {{ $days }}</div>
						@elseif($days > 0 && $days < 15)
							<div id="div_alert_error" class="alert alert-success"> {{ $days }}</div>
						@elseif($days >= 15 && $days < 25)
							<div id="div_alert_error" class="alert alert-warning"> {{ $days }}</div>
						@else
							<div id="div_alert_error" class="alert alert-danger"> {{ $days }}</div>
						@endif
					@endif
				</td>
				<td>
				@if($tarea->estado == 0)
					<div id="div_alert_error" class="alert alert-info">Closed</div></td>
				@else
					@if($tarea->status == "Closed")
						<div id="div_alert_error" class="alert alert-warning"> Pendiente de encuesta </div>
					@else
						<div id="div_alert_error" class="alert alert-success"> {{ $tarea->status }}</div>
					@endif
				@endif
				</td>
				<td>
				<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="{{ $tarea->progreso }}" aria-valuemin="0" aria-valuemax="100" style="width:{{ $tarea->progreso }}%">{{ $tarea->progreso }}%</div></div>
				</td>
			</tr>
		    @endforeach
		</tbody>
	    </table>
	</div>
	<center>
	    {{ $tareas->links() }}
	</center>
	<script>
	    $("#tabla_tareas tbody tr").click(function(){
		getIssue($(this).children("td").html());
	    });
	</script>

<!-- Modal -->
<div class="modal fade" id="myModal" role="dialog">
<div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
	<div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal">&times;</button>
	    <h4 class="modal-title">Encuesta de finalización</h4>
	</div>
	<div class="modal-body">
	    <label>¿Se cumplió con el requerimiento?</label><br>
	    <input type="radio" name="rst_req" value="1" checked>Sí
	    <input type="radio" name="rst_req" value="0">No
	    <br>
	    <label>¿Cómo calificaría el tiempo que tardó la OT en ser resuelta?</label><br>
	    <label>Malo</label>
	    <input type="radio" name="rst_time_req" value="1">1
	    <input type="radio" name="rst_time_req" value="2">2
	    <input type="radio" name="rst_time_req" value="3">3
	    <input type="radio" name="rst_time_req" value="4">4
	    <input type="radio" name="rst_time_req" value="5" checked>5
	    <label>Bueno</label>
	    <br>	    
	    <label>Observaciones</label>
	    <input id="enc_obs" type="text">
	</div>
   	<div class="modal-footer">
  	    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
  	    <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="ingresar_encuesta()">Aceptar</button>
	</div>
    </div>
</div>
</div>
	<script>
	    $( document ).ready(function() {
			getIssue({{ $id_defautl }});
		});
	</script>
    </body>
</html>
